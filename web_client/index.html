<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Petting Zootopia</title>
    <style>
        :root{
          --paper:#FFF6EC;
          --ink:#3A2E2A;
          --orange:#F4A259;
          --orange-deep:#E07A35;
          --brown:#8B5E3C;
          --yellow:#F4C23A;
          --sage:#A9C48C;
          --sky:#CFE7F5;
          --error:#C0392B;
          --ring:#2D9CDB;
          --card:#FFFFFF;
          --muted:#F4EFE8;
          --shadow:0 10px 24px rgba(0,0,0,.08);
          --radius:16px;
        }
      
        *{box-sizing:border-box}
        html,body{height:100%}
        body{
          font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
          color:var(--ink);
          background:
            radial-gradient(1200px 600px at 70% -10%, var(--sky), transparent 60%),
            radial-gradient(900px 500px at 10% 0%, var(--sage), transparent 50%),
            var(--paper);
          display:flex; align-items:center; justify-content:center;
          padding:32px;
        }
      
        .container{
          width:100%; max-width:720px;
          background:var(--card);
          border-radius:var(--radius);
          box-shadow:var(--shadow);
          padding:40px 40px 32px;
        }
      
        header{
          display:flex; align-items:center; gap:16px; justify-content:center; margin-bottom:16px;
        }
        h1{
          font-size:clamp(24px, 4vw, 34px);
          font-weight:800; letter-spacing:.2px;
          color:var(--ink);
        }
        .tagline{
          color:#6B5F59; margin-top:4px; text-align:center;
        }
      
        .landing-image{
          width:100%; max-width:520px; height:auto;
          display:block; margin:24px auto 8px;
          border-radius:14px; box-shadow:var(--shadow);
          background:var(--muted);
        }
      
        .buttons-container{
          display:flex; flex-wrap:wrap; justify-content:center; gap:12px; margin-top:20px;
        }
      
        .animal-button{
          --bg:var(--orange);
          --bg-hover:var(--orange-deep);
          background:var(--bg); color:#fff;
          border:1px solid rgba(0,0,0,.05);
          padding:12px 18px; border-radius:999px;
          font-weight:700; font-size:16px;
          cursor:pointer; transition:transform .08s ease, box-shadow .2s ease, background .2s ease;
          box-shadow:0 2px 0 rgba(0,0,0,.12);
        }
        .animal-button:hover{background:var(--bg-hover)}
        .animal-button:active{transform:translateY(1px)}
        .animal-button:focus-visible{
          outline:3px solid var(--ring); outline-offset:2px;
        }
        .animal-button.duck{ --bg:var(--yellow); --bg-hover:#E2B12F; color:#3b2a22 }
        .animal-button.dog{ --bg:var(--brown); --bg-hover:#754A32 }
        .animal-button.cat{ --bg:var(--orange); --bg-hover:var(--orange-deep) }
      
      
        .loading{
          display:none; margin:18px 0; text-align:center;
        }
      
        .progress{
          width:100%; max-width:360px; height:8px; background:#E9E1D9;
          margin:10px auto 0; border-radius:999px; overflow:hidden;
        }
        .bar{height:100%; width:0%; background:var(--sage)}
      
        .error{
          display:none; margin:18px 0; padding:12px 14px;
          background:#FDEDEC; color:var(--error); border:1px solid #F5B7B1; border-radius:10px;
        }
      
        footer{margin-top:18px; text-align:center; font-size:12px; color:#7B6F68}
        @media (max-width:640px){ .container{padding:24px} }
      </style>
      
</head>
<body>
    <div class="container">
        <h1>üêæ Welcome to Petting Zootopia! üêæ</h1>
        
        <img id="hero-image" 
             src="assets/images/petting_zoo_hero.png" 
             alt="Petting Zoo" 
             class="landing-image" 
             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjI1MCIgdmlld0JveD0iMCAwIDQwMCAyNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI0MDAiIGhlaWdodD0iMjUwIiBmaWxsPSIjRjBGMEYwIi8+Cjx0ZXh0IHg9IjIwMCIgeT0iMTI1IiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTgiIGZpbGw9IiM5OTk5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5QZXR0aW5nIFpvb3RvcGlhPC90ZXh0Pgo8L3N2Zz4K'">
             <p class="tagline">Browse a friendly menagerie ‚Äî cat, duck, and dog.</p>

        <div class="buttons-container">
            <button class="animal-button duck" onclick="requestAnimal('duck')">
                ü¶Ü Duck
            </button>
            <button class="animal-button dog" onclick="requestAnimal('dog')">
                üê∂ Dog
            </button>
            <button class="animal-button cat" onclick="requestAnimal('cat')">
                üê± Cat
            </button>
            <button class="animal-button" onclick="resetHeroImage()" style="--bg: var(--sage); --bg-hover: #8FAF6B;">
                üè† Reset
            </button>
        </div>

        <div class="loading" id="loading">
            üêæ Finding your perfect animal... üêæ
        </div>
        <div class="progress" id="progress" aria-hidden="true"><div class="bar" id="bar"></div></div>

        <div class="error" id="error">
            Oops! Something went wrong. Please try again.
        </div>

    </div>

    <script>
        // Global state management
        let isProcessing = false;
        let currentRequest = null;
        
        async function requestAnimal(animalType) {
            // Prevent multiple simultaneous requests
            if (isProcessing) {
                console.log('Request already in progress, ignoring...');
                return;
            }
            
            // Set processing state
            isProcessing = true;
            currentRequest = animalType;
            
            // Hide previous errors
            document.getElementById('error').style.display = 'none';
            
            // Show loading with initial message
            const loadingElement = document.getElementById('loading');
            loadingElement.style.display = 'block';
            loadingElement.innerHTML = 'üêæ Finding your perfect animal... üêæ';
            
            // Store original hero image for potential restoration
            const heroImage = document.getElementById('hero-image');
            const originalHeroSrc = heroImage.src;
            
            // Reset hero image to original if it was showing a sad animal
            if (heroImage.src.includes('sad_')) {
                heroImage.src = 'assets/images/petting_zoo_hero.png';
                heroImage.alt = 'Petting Zoo';
            }
            
            try {
                // Send request to our backend
                const response = await fetch('/api/animal', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        animal: animalType,
                        message: `I want a ${animalType}!`
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.success && data.imageUrl) {
                    // Check if this is still the current request
                    if (currentRequest !== animalType) {
                        return;
                    }
                    
                    // Set up timeout for image loading (10 seconds)
                    const imageTimeout = setTimeout(() => {
                        if (currentRequest === animalType) {
                            document.getElementById('loading').style.display = 'none';
                            showSadAnimal(animalType);
                        }
                    }, 10000);
                    
                    // Create a test image to verify the URL works
                    const testImage = new Image();
                    
                    testImage.onload = function() {
                        // Check if this is still the current request
                        if (currentRequest !== animalType) {
                            return;
                        }
                        
                        // Image loaded successfully - clear timeout
                        clearTimeout(imageTimeout);
                        document.getElementById('loading').style.display = 'none';
                        
                        // Update hero image to show the animal
                        const heroImage = document.getElementById('hero-image');
                        heroImage.src = data.imageUrl;
                        heroImage.alt = `${data.animal} image`;
                        
                        // Clear processing state
                        isProcessing = false;
                        currentRequest = null;
                    };
                    
                    testImage.onerror = function() {
                        clearTimeout(imageTimeout);
                        if (currentRequest === animalType) {
                            document.getElementById('loading').style.display = 'none';
                            showSadAnimal(animalType);
                        }
                    };
                    
                    // Update loading message
                    loadingElement.innerHTML = 'üñºÔ∏è Loading your animal image... üñºÔ∏è';
                    
                    // Start loading the image
                    testImage.src = data.imageUrl;
                } else {
                    throw new Error(data.error || 'No image received');
                }
                
            } catch (error) {
                // Only show error if this is still the current request
                if (currentRequest === animalType) {
                    document.getElementById('loading').style.display = 'none';
                    showSadAnimal(animalType);
                }
            }
        }

        function showSadAnimal(animalType) {
            const sadImages = {
                'cat': 'assets/images/sad_cat.jpg',
                'dog': 'assets/images/sad_dog.jpg',
                'duck': 'assets/images/sad_duck.jpg'
            };
            
            const sadImageUrl = sadImages[animalType] || sadImages['cat'];
            
            // Update hero image to show sad animal
            const heroImage = document.getElementById('hero-image');
            heroImage.src = sadImageUrl;
            heroImage.alt = `Sad ${animalType}`;
            
            // Show error message
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').innerHTML = 
                `<strong>Sorry, we couldn't find a ${animalType} right now! üò¢</strong><br>
                 Here's a sad ${animalType} instead. Please try again later.`;
            
            // Clear processing state
            isProcessing = false;
            currentRequest = null;
        }
        
        // Function to reset hero image to original
        function resetHeroImage() {
            const heroImage = document.getElementById('hero-image');
            heroImage.src = 'assets/images/petting_zoo_hero.png';
            heroImage.alt = 'Petting Zoo';
        }
    </script>
</body>
</html>